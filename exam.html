<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IngresoU — Examen Completo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body{background:#f6f7ff} </style>
</head>
<body class="text-gray-900">
  <div class="mx-auto max-w-4xl p-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Examen completo</h1>
      <div class="flex items-center gap-3">
        <div class="w-48 h-2 rounded bg-gray-200 overflow-hidden"><div id="pbar" class="h-2 bg-indigo-600" style="width:0%"></div></div>
        <div id="timer" class="rounded-xl bg-black px-3 py-1 text-white text-sm">--:--</div>
        <a href="/premium.html" class="rounded-xl border px-3 py-1 text-sm">Salir</a>
      </div>
    </header>

    <section id="setup" class="mt-5 rounded-2xl bg-white p-5 ring-1 ring-gray-200 shadow">
      <div class="text-sm text-gray-700">Selecciona universidad y comienza cuando estés listo.</div>
      <div class="mt-3 flex flex-wrap items-center gap-3">
        <label class="flex items-center gap-2"><input type="radio" name="u" value="Examen UTP" checked> UTP</label>
        <label class="flex items-center gap-2"><input type="radio" name="u" value="Examen UP"> UP</label>
        <div class="ml-auto text-sm text-gray-600">Duración: <b>90:00</b> — 60 preguntas (20 por área)</div>
      </div>
      <div class="mt-3">
        <button id="btnStart" class="rounded-xl bg-indigo-600 px-4 py-2 text-white">Comenzar</button>
      </div>
    </section>

    <div id="app" class="mt-4 rounded-2xl bg-white p-5 ring-1 ring-gray-200 shadow hidden"></div>
  </div>


<script>
async function ensureSession(){
  const s = JSON.parse(localStorage.getItem('ingresou_session')||'null');
  if(!s){ location.href = '/premium.html'; return null; }
  try{
    const r = await fetch('/api/get-subscription', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code: s.code, email: s.email })});
    const data = await r.json();
    if(!(r.ok && data.ok)){ location.href = '/premium.html'; return null; }
    return {session:s, sub:data};
  }catch(e){ location.href = '/premium.html'; return null; }
}
</script>


<script>
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function pickN(arr,n){ const a=[...arr]; shuffle(a); return a.slice(0, Math.min(n,a.length)); }
function saveLocal(moduleName, score, total, ms){
  try{ const key='ingresou_results'; const list=JSON.parse(localStorage.getItem(key)||'[]'); list.unshift({module:moduleName,score,total,ms,ts:Date.now()}); while(list.length>50) list.pop(); localStorage.setItem(key, JSON.stringify(list)); }catch(e){}
}
function fmtMs(ms){ const s=Math.max(0,Math.round(ms/1000)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }
async function submitGlobal(moduleName, score, total, ms){
  const s = JSON.parse(localStorage.getItem('ingresou_session')||'null'); if(!s) return {ok:false};
  try{
    const r = await fetch('/api/submit-score', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code: s.code, email: s.email, module: moduleName, score, total, ms })});
    return await r.json();
  }catch(e){ return {ok:false}; }
}
async function fetchTop(moduleName, limit=10){
  try{ const r= await fetch('/api/top-scores?module='+encodeURIComponent(moduleName)+'&limit='+limit); const j= await r.json(); return j && j.ok ? j.top : []; }catch(e){ return []; }
}
</script>

<script>
const TOTAL_SECONDS = 90*60;
const PASS_RATIO = 0.70; // umbral referencial: 70%

async function loadBanks(){
  const [a,l,c] = await Promise.all([
    fetch('/bank/algebra.json').then(r=>r.json()),
    fetch('/bank/logico.json').then(r=>r.json()),
    fetch('/bank/lectura.json').then(r=>r.json()),
  ]);
  return { algebra:a, logico:l, lectura:c };
}

function assembleExam(banks){
  const A = pickN(banks.algebra, 20).map(x=>({...x, area:'Álgebra'}));
  const L = pickN(banks.logico, 20).map(x=>({...x, area:'Lógico'}));
  const C = pickN(banks.lectura, 20).map(x=>({...x, area:'Lectura'}));
  const qs = shuffle([...A,...L,...C]);
  // shuffle options and fix answer index
  for(const q of qs){ const correctText = q.options[q.a]; q.options = shuffle([...q.options]); q.a = q.options.indexOf(correctText); }
  return qs;
}

function startExam(moduleName, QUESTIONS){
  document.getElementById('setup').classList.add('hidden');
  const app=document.getElementById('app'); app.classList.remove('hidden');
  const pbar=document.getElementById('pbar'); const timer=document.getElementById('timer');

  let i=0; let finished=false; const answers=new Array(QUESTIONS.length).fill(null);
  let remaining=TOTAL_SECONDS; timer.textContent=fmtMs(remaining);
  const tHandle=setInterval(()=>{ if(finished) return; remaining--; if(remaining<=0){remaining=0; finished=true; render();} timer.textContent=fmtMs(remaining); },1000);

  // Evitar retroceso de navegador (suave)
  const noop = (e)=>{ e.preventDefault(); e.returnValue=''; return ''; };
  window.onbeforeunload = noop;

  async function render(){
    app.innerHTML=''; pbar.style.width=Math.round((i/QUESTIONS.length)*100)+'%';
    if(!finished){
      const q=QUESTIONS[i];
      const wrap=document.createElement('div'); wrap.innerHTML=`
        <div class="text-sm text-gray-600">Pregunta ${i+1} de ${QUESTIONS.length}</div>
        <div class="mt-2 text-lg font-medium">${q.q}</div>
        <div class="mt-4 space-y-2"></div>
        <div class="mt-4 flex justify-between">
          <span class="text-xs text-gray-500">* En el examen no puedes volver atrás.</span>
          <button id="nextBtn" class="rounded-xl bg-indigo-600 px-4 py-2 text-white">${i<QUESTIONS.length-1?'Siguiente':'Finalizar'}</button>`;
      const list=wrap.children[2];
      q.options.forEach((opt,idx)=>{ const b=document.createElement('button'); b.className="w-full rounded-xl border px-4 py-2 text-left hover:bg-gray-50 " + (answers[i]===idx?"ring-2 ring-indigo-500":""); b.innerHTML=`<span class="mr-2">${String.fromCharCode(65+idx)}.</span> ${opt}`; b.onclick=()=>{ answers[i]=idx; render(); }; list.appendChild(b); });
      app.appendChild(wrap);
      document.getElementById('nextBtn').onclick=()=>{ if(i<QUESTIONS.length-1){i++; render();} else {finished=true; render();} };
    } else {
      clearInterval(tHandle); window.onbeforeunload = null; pbar.style.width='100%';
      const elapsed=(TOTAL_SECONDS-remaining)*1000;
      // score & per-area report
      let correct=0; const byArea={"Álgebra":{t:0,c:0},"Lógico":{t:0,c:0},"Lectura":{t:0,c:0}};
      QUESTIONS.forEach((q,idx)=>{ byArea[q.area].t++; const ok=answers[idx]===q.a; if(ok){ correct++; byArea[q.area].c++; } });
      const ratio = correct/QUESTIONS.length; const passed = ratio >= PASS_RATIO;

      const sugg = Object.entries(byArea).map(([k,v])=>{ const r=v.c/v.t; return `<li>${k}: ${v.c}/${v.t} — ${
        (r>=0.8)?'Excelente':(r>=0.7)?'Bien':(r>=0.5)?'Mejorar':'Refuerzo urgente'
      }</li>`; }).join('');

      // Build review (opcional: oculto por defecto)
      let review=''; QUESTIONS.forEach((q,idx)=>{ const ok=answers[idx]===q.a; const chosen=answers[idx]==null?'—':q.options[answers[idx]]; review += `
        <details class="rounded-xl border p-3 mt-3">
          <summary class="cursor-pointer"><span class="text-sm ${
            ok?'text-green-700':'text-red-700'
          }">${ok?'✔':'✖'} [${q.area}] — ${q.q}</span></summary>
          <div class="mt-2 text-sm"><b>Tu respuesta:</b> ${chosen}</div>
          <div class="mt-1 text-sm"><b>Correcta:</b> ${q.options[q.a]}</div>
          <div class="mt-1 text-sm text-gray-700">${q.exp||''}</div>
        </details>`; });

      saveLocal(moduleName, correct, QUESTIONS.length, elapsed);
      const global = await submitGlobal(moduleName, correct, QUESTIONS.length, elapsed);
      const top = global && global.ok ? global.top : await fetchTop(moduleName,10);
      const topHtml=(top||[]).map((r,idx)=>{ const mm=Math.floor(r.ms/60000), ss=String(Math.floor(r.ms/1000)%60).padStart(2,'0'); const d=new Date(r.created_at).toLocaleDateString(); return `<div class="flex justify-between text-sm"><span>#${idx+1} — ${r.score}/${r.total}</span><span>${mm}:${ss} · ${d}</span></div>`; }).join('');

      const wrap=document.createElement('div'); wrap.innerHTML=`
        <div class="text-xl font-semibold ${
          passed?'text-green-700':'text-orange-700'
        }">${passed?'APROBADO':'EN PROCESO'} — ${correct} / ${QUESTIONS.length} (${
          Math.round(ratio*100)
        }%)</div>
        <div class="text-sm text-gray-600">Tiempo usado: ${fmtMs(elapsed)}</div>

        <div class="mt-4 rounded-2xl bg-indigo-50 p-4">
          <div class="text-sm font-semibold text-indigo-900">Reporte por áreas</div>
          <ul class="mt-1 text-sm">${sugg}</ul>
          <div class="mt-2 text-xs text-gray-600">Umbral referencial: ${Math.round(PASS_RATIO*100)}%</div>
        </div>

        <div class="mt-4 flex gap-2">
          <a href="/premium.html" class="rounded-xl bg-black px-4 py-2 text-white">Volver a Mi cuenta</a>
          <button id="retry" class="rounded-xl border px-4 py-2">Reintentar</button>
          <a href="/leaderboard.html" class="rounded-xl border px-4 py-2">Ver ranking</a>
        </div>

        <div class="mt-6 rounded-2xl bg-indigo-50 p-4">
          <div class="text-sm font-semibold text-indigo-900">Ranking global (Top 10)</div>
          <div class="mt-2">${topHtml || '<div class="text-sm">Aún no hay registros.</div>'}</div>
        </div>

        <div class="mt-6">
          <details class="rounded-2xl bg-white p-3 ring-1 ring-gray-200"><summary class="cursor-pointer text-sm">Ver revisión completa</summary>
            <div class="mt-2">${review}</div>
          </details>
        </div>`;
      app.appendChild(wrap);
      document.getElementById('retry').onclick=()=>{ location.reload(); };
    }
  }
  render();
}

ensureSession().then(async s=>{ if(!s) return; const banks=await loadBanks(); document.getElementById('btnStart').onclick=()=>{ const mod = document.querySelector('input[name="u"]:checked').value; const qs = assembleExam(banks); startExam(mod, qs); }; });
</script>
</body>
</html>
