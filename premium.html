<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IngresoU — Mi cuenta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex,nofollow"/>
  <style> body { background: #f6f7ff; } </style>
</head>
<body class="text-gray-900">
  <div class="mx-auto max-w-5xl p-6">
   <header class="flex items-center justify-between">
  <h1 class="text-2xl font-bold">IngresoU — Mi cuenta</h1>
  <div class="flex items-center gap-2">
    <a href="/leaderboard.html" class="rounded-xl border px-4 py-2 text-sm">
      Ver ranking
    </a>
    <button id="logoutBtn" class="rounded-xl border px-4 py-2 text-sm">
      Cerrar sesión
    </button>
  </div>
</header>


    <div id="status" class="mt-6 text-sm text-gray-600">Verificando tu acceso…</div>

    <section id="account" class="mt-6 hidden">
      <div class="rounded-2xl bg-white p-6 shadow ring-1 ring-gray-200">
        <h2 class="text-xl font-semibold">Tu suscripción</h2>
        <div class="mt-3 grid gap-4 sm:grid-cols-3">
          <div class="rounded-xl bg-indigo-50 p-4"><div class="text-xs text-indigo-700">Universidad</div><div id="accUni" class="text-lg font-semibold">—</div></div>
          <div class="rounded-xl bg-indigo-50 p-4"><div class="text-xs text-indigo-700">Plan</div><div id="accPlan" class="text-lg font-semibold">—</div></div>
          <div class="rounded-xl bg-indigo-50 p-4"><div class="text-xs text-indigo-700">Vence</div><div id="accExp" class="text-lg font-semibold">—</div></div>
        </div>
      </div>

      <div class="mt-8">
  <h3 class="text-lg font-semibold">Módulos Premium</h3>

  <!-- grid actualizada: 2 cols en pantallas pequeñas, 4 en grandes -->
  <div class="mt-3 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <a href="/practice-algebra.html" class="rounded-2xl border bg-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Álgebra Básica</div>
      <p class="mt-1 text-xs text-gray-600">Ecuaciones, factorización, proporciones.</p>
      <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Practicar 10 preguntas</div>
    </a>

    <a href="/practice-logico.html" class="rounded-2xl border bg-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Razonamiento Lógico</div>
      <p class="mt-1 text-xs text-gray-600">Series, patrones y analogías.</p>
      <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Practicar 10 preguntas</div>
    </a>

    <a href="/practice-lectura.html" class="rounded-2xl border bg-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Comprensión Lectora</div>
      <p class="mt-1 text-xs text-gray-600">Lecturas cortas con preguntas.</p>
      <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Practicar 10 preguntas</div>
    </a>

    <!-- NUEVA TARJETA: Ranking global -->
    <a href="/leaderboard.html" class="rounded-2xl border bg-gradient-to-br from-indigo-50 to-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Ranking global</div>
      <p class="mt-1 text-xs text-gray-600">Top 100 por módulo · puntaje y tiempo.</p>
      <div class="mt-3 inline-block rounded-lg bg-black px-3 py-1 text-xs text-white">Ver ranking</div>
    </a>
    <!-- Tarjeta: Examen completo -->
<a href="/exam.html" class="rounded-2xl border bg-white p-5 hover:shadow">
  <div class="text-sm font-semibold">Examen completo</div>
  <p class="mt-1 text-xs text-gray-600">60 preguntas · 90 min · UTP/UP</p>
  <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Empezar examen</div>
</a>
  </div>
</div>


      <div class="mt-8">
        <h3 class="text-lg font-semibold">Tus mejores marcas</h3>
        <div id="bests" class="mt-3 grid gap-4 md:grid-cols-3"></div>
      </div>

      <div class="mt-8">
        <h3 class="text-lg font-semibold">Tus últimos resultados (local)</h3>
        <div id="results" class="mt-2 text-sm text-gray-700"></div>
      </div>
    </section>

    <section id="login" class="mt-6 hidden">
      <div class="rounded-2xl bg-white p-6 shadow ring-1 ring-gray-200">
        <h2 class="text-lg font-semibold">Inicia sesión con tu KEY</h2>
        <p class="text-sm text-gray-600">Si cambiaste de dispositivo, vuelve a validar tu acceso.</p>
        <div class="mt-4 grid gap-3 md:grid-cols-3">
          <input id="loginCode" class="rounded-xl border px-4 py-2 md:col-span-1" placeholder="UTP-AB12-4578"/>
          <input id="loginEmail" type="email" class="rounded-xl border px-4 py-2 md:col-span-1" placeholder="Tu correo"/>
          <button id="loginBtn" class="rounded-xl bg-indigo-600 px-4 py-2 text-white md:col-span-1">Entrar</button>
        </div>
        <div id="loginMsg" class="mt-3 text-sm"></div>
      </div>
    </section>
  </div>

<script>
const MODULES = ["Álgebra Básica","Razonamiento Lógico","Comprensión Lectora"];
function getSession(){ try { return JSON.parse(localStorage.getItem('ingresou_session')||'null'); } catch { return null; } }
function setSession(obj){ localStorage.setItem('ingresou_session', JSON.stringify(obj)); }
function clearSession(){ localStorage.removeItem('ingresou_session'); }

function loadResults(){
  try{
    const list = JSON.parse(localStorage.getItem('ingresou_results')||'[]');
    const box = document.getElementById('results');
    if(!list.length){ box.textContent = 'Aún no tienes intentos locales.'; return; }
    box.innerHTML = list.slice(0,10).map(r=>{
      const d = new Date(r.ts).toLocaleString();
      return `<div class="rounded-xl border p-2 mb-2 flex justify-between">
        <span><b>${r.module}</b> — ${r.score}/${r.total}</span>
        <span class="text-gray-500">${d}</span>
      </div>`;
    }).join('');
  }catch(e){}
}

async function fetchBest(code, email, module){
  const r = await fetch('/api/my-best', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, email, module }) });
  const data = await r.json();
  return data && data.ok ? data.best : null;
}

async function loadBests(code, email){
  const box = document.getElementById('bests');
  box.innerHTML = '';
  for (const m of MODULES){
    const best = await fetchBest(code, email, m);
    const html = `<div class="rounded-2xl bg-white p-4 ring-1 ring-gray-200">
      <div class="text-sm font-semibold">${m}</div>
      ${best ? `<div class="mt-1 text-sm">Mejor: <b>${best.score}/${best.total}</b> · ${Math.floor(best.ms/60000)}:${String(Math.floor(best.ms/1000)%60).padStart(2,'0')}</div>
                <div class="text-xs text-gray-500">Fecha: ${new Date(best.created_at).toLocaleDateString()}</div>`
             : `<div class="mt-1 text-sm text-gray-600">Aún no tienes marca. ¡Intenta el módulo!</div>`}
    </div>`;
    const el = document.createElement('div'); el.innerHTML = html; box.appendChild(el.firstChild);
  }
}

async function verify(code, email){
  const r = await fetch('/api/get-subscription', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, email }) });
  const data = await r.json();
  return { ok: r.ok && data.ok, data };
}

async function boot(){
  const status = document.getElementById('status');
  const acc = document.getElementById('account');
  const login = document.getElementById('login');
  const s = getSession();
  if (!s) { status.textContent = 'Necesitas iniciar sesión con tu KEY.'; login.classList.remove('hidden'); return; }
  status.textContent = 'Verificando…';
  const { ok, data } = await verify(s.code, s.email);
  if (!ok) { status.textContent = 'No pudimos verificar tu acceso ('+(data.error||'')+'). Inicia sesión de nuevo.'; login.classList.remove('hidden'); return; }
  status.className = 'mt-6 text-sm text-green-700'; status.textContent = '✔ Acceso verificado.';
  document.getElementById('accUni').textContent = data.university;
  document.getElementById('accPlan').textContent = data.plan;
  document.getElementById('accExp').textContent = new Date(data.expires_at).toLocaleDateString();
  acc.classList.remove('hidden');
  loadResults();
  loadBests(s.code, s.email);
}

document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearSession(); location.reload(); });
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const code = document.getElementById('loginCode').value.trim().toUpperCase();
  const email = document.getElementById('loginEmail').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.className = 'mt-3 text-sm text-gray-700'; msg.textContent = 'Verificando…';
  const { ok, data } = await verify(code, email);
  if (ok) { setSession({ code, email, at: Date.now() }); msg.className = 'mt-3 text-sm text-green-700'; msg.textContent = '✔ Acceso válido. Cargando…'; setTimeout(()=>location.reload(), 500); }
  else { msg.className = 'mt-3 text-sm text-red-700'; msg.textContent = '✖ '+(data.error||'No autorizado'); }
});

boot();
</script>
</body>
</html>
