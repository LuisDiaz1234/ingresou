<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IngresoU — Mi cuenta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="robots" content="noindex,nofollow"/>
  <style> body { background: #f6f7ff; } </style>
</head>
<body class="text-gray-900">
  <div class="mx-auto max-w-5xl p-6">
   <header class="flex items-center justify-between">
  <h1 class="text-2xl font-bold">IngresoU — Mi cuenta</h1>
  <div class="flex items-center gap-2">
    <a href="/leaderboard.html" class="rounded-xl border px-4 py-2 text-sm">
      Ver ranking
    </a>
    <button id="logoutBtn" class="rounded-xl border px-4 py-2 text-sm">
      Cerrar sesión
    </button>
  </div>
</header>


    <div id="status" class="mt-6 text-sm text-gray-600">Verificando tu acceso…</div>

    <section id="account" class="mt-6 hidden">
      <div class="rounded-2xl bg-white p-6 shadow ring-1 ring-gray-200">
        <h2 class="text-xl font-semibold">Tu suscripción</h2>
        <div class="mt-3 grid gap-4 sm:grid-cols-3">
          <div class="rounded-xl bg-indigo-50 p-4"><div class="text-xs text-indigo-700">Universidad</div><div id="accUni" class="text-lg font-semibold">—</div></div>
          <div class="rounded-xl bg-indigo-50 p-4"><div class="text-xs text-indigo-700">Plan</div><div id="accPlan" class="text-lg font-semibold">—</div></div>
          <div class="rounded-xl bg-indigo-50 p-4"><div class="text-xs text-indigo-700">Vence</div><div id="accExp" class="text-lg font-semibold">—</div></div>
        </div>
      </div>

      <div class="mt-8">
  <h3 class="text-lg font-semibold">Módulos Premium</h3>

  <!-- grid actualizada: 2 cols en pantallas pequeñas, 4 en grandes -->
  <div class="mt-3 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <a href="/practice-algebra.html" class="rounded-2xl border bg-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Álgebra Básica</div>
      <p class="mt-1 text-xs text-gray-600">Ecuaciones, factorización, proporciones.</p>
      <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Practicar 10 preguntas</div>
    </a>

    <a href="/practice-logico.html" class="rounded-2xl border bg-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Razonamiento Lógico</div>
      <p class="mt-1 text-xs text-gray-600">Series, patrones y analogías.</p>
      <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Practicar 10 preguntas</div>
    </a>

    <a href="/practice-lectura.html" class="rounded-2xl border bg-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Comprensión Lectora</div>
      <p class="mt-1 text-xs text-gray-600">Lecturas cortas con preguntas.</p>
      <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Practicar 10 preguntas</div>
    </a>

    <!-- NUEVA TARJETA: Ranking global -->
    <a href="/leaderboard.html" class="rounded-2xl border bg-gradient-to-br from-indigo-50 to-white p-5 hover:shadow">
      <div class="text-sm font-semibold">Ranking global</div>
      <p class="mt-1 text-xs text-gray-600">Top 100 por módulo · puntaje y tiempo.</p>
      <div class="mt-3 inline-block rounded-lg bg-black px-3 py-1 text-xs text-white">Ver ranking</div>
    </a>
    <!-- Tarjeta: Examen completo -->
<a href="/exam.html" class="rounded-2xl border bg-white p-5 hover:shadow">
  <div class="text-sm font-semibold">Examen completo</div>
  <p class="mt-1 text-xs text-gray-600">60 preguntas · 90 min · UTP/UP</p>
  <div class="mt-3 inline-block rounded-lg bg-indigo-600 px-3 py-1 text-xs text-white">Empezar examen</div>
</a>
  </div>
</div>


      <div class="mt-8">
        <h3 class="text-lg font-semibold">Tus mejores marcas</h3>
        <div id="bests" class="mt-3 grid gap-4 md:grid-cols-3"></div>
      </div>

      <div class="mt-8">
        <h3 class="text-lg font-semibold">Tus últimos resultados (local)</h3>
        <div id="results" class="mt-2 text-sm text-gray-700"></div>
      </div>
    </section>

    <section id="login" class="mt-6 hidden">
      <div class="rounded-2xl bg-white p-6 shadow ring-1 ring-gray-200">
        <h2 class="text-lg font-semibold">Inicia sesión con tu KEY</h2>
        <p class="text-sm text-gray-600">Si cambiaste de dispositivo, vuelve a validar tu acceso.</p>
        <div class="mt-4 grid gap-3 md:grid-cols-3">
          <input id="loginCode" class="rounded-xl border px-4 py-2 md:col-span-1" placeholder="UTP-AB12-4578"/>
          <input id="loginEmail" type="email" class="rounded-xl border px-4 py-2 md:col-span-1" placeholder="Tu correo"/>
          <button id="loginBtn" class="rounded-xl bg-indigo-600 px-4 py-2 text-white md:col-span-1">Entrar</button>
        </div>
        <div id="loginMsg" class="mt-3 text-sm"></div>
      </div>
    </section>
  </div>

<script>
const MODULES = ["Álgebra Básica","Razonamiento Lógico","Comprensión Lectora"];
function getSession(){ try { return JSON.parse(localStorage.getItem('ingresou_session')||'null'); } catch { return null; } }
function setSession(obj){ localStorage.setItem('ingresou_session', JSON.stringify(obj)); }
function clearSession(){ localStorage.removeItem('ingresou_session'); }

function loadResults(){
  try{
    const list = JSON.parse(localStorage.getItem('ingresou_results')||'[]');
    const box = document.getElementById('results');
    if(!list.length){ box.textContent = 'Aún no tienes intentos locales.'; return; }
    box.innerHTML = list.slice(0,10).map(r=>{
      const d = new Date(r.ts).toLocaleString();
      return `<div class="rounded-xl border p-2 mb-2 flex justify-between">
        <span><b>${r.module}</b> — ${r.score}/${r.total}</span>
        <span class="text-gray-500">${d}</span>
      </div>`;
    }).join('');
  }catch(e){}
}

async function fetchBest(code, email, module){
  const r = await fetch('/api/my-best', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, email, module }) });
  const data = await r.json();
  return data && data.ok ? data.best : null;
}

async function loadBests(code, email){
  const box = document.getElementById('bests');
  box.innerHTML = '';
  for (const m of MODULES){
    const best = await fetchBest(code, email, m);
    const html = `<div class="rounded-2xl bg-white p-4 ring-1 ring-gray-200">
      <div class="text-sm font-semibold">${m}</div>
      ${best ? `<div class="mt-1 text-sm">Mejor: <b>${best.score}/${best.total}</b> · ${Math.floor(best.ms/60000)}:${String(Math.floor(best.ms/1000)%60).padStart(2,'0')}</div>
                <div class="text-xs text-gray-500">Fecha: ${new Date(best.created_at).toLocaleDateString()}</div>`
             : `<div class="mt-1 text-sm text-gray-600">Aún no tienes marca. ¡Intenta el módulo!</div>`}
    </div>`;
    const el = document.createElement('div'); el.innerHTML = html; box.appendChild(el.firstChild);
  }
}

async function verify(code, email){
  const r = await fetch('/api/get-subscription', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, email }) });
  const data = await r.json();
  return { ok: r.ok && data.ok, data };
}

async function boot(){
  const status = document.getElementById('status');
  const acc = document.getElementById('account');
  const login = document.getElementById('login');
  const s = getSession();
  if (!s) { status.textContent = 'Necesitas iniciar sesión con tu KEY.'; login.classList.remove('hidden'); return; }
  status.textContent = 'Verificando…';
  const { ok, data } = await verify(s.code, s.email);
  if (!ok) { status.textContent = 'No pudimos verificar tu acceso ('+(data.error||'')+'). Inicia sesión de nuevo.'; login.classList.remove('hidden'); return; }
  status.className = 'mt-6 text-sm text-green-700'; status.textContent = '✔ Acceso verificado.';
  document.getElementById('accUni').textContent = data.university;
  document.getElementById('accPlan').textContent = data.plan;
  document.getElementById('accExp').textContent = new Date(data.expires_at).toLocaleDateString();
  acc.classList.remove('hidden');
  loadResults();
  loadBests(s.code, s.email);
}

document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearSession(); location.reload(); });
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const code = document.getElementById('loginCode').value.trim().toUpperCase();
  const email = document.getElementById('loginEmail').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.className = 'mt-3 text-sm text-gray-700'; msg.textContent = 'Verificando…';
  const { ok, data } = await verify(code, email);
  if (ok) { setSession({ code, email, at: Date.now() }); msg.className = 'mt-3 text-sm text-green-700'; msg.textContent = '✔ Acceso válido. Cargando…'; setTimeout(()=>location.reload(), 500); }
  else { msg.className = 'mt-3 text-sm text-red-700'; msg.textContent = '✖ '+(data.error||'No autorizado'); }
});

boot();
</script>
  <script>
/* ========= IngresoU — Aviso de Renovación (autoinstalable) =========
   Qué hace:
   - Calcula días restantes con base en la suscripción.
   - Si faltan ≤ THRESHOLD_DAYS o ya expiró, muestra un banner con:
       * Botón "Renovar por WhatsApp" (usa tu número).
       * Botón "Copiar datos" (para Yappy/uso manual).
   - Se inserta automático debajo de "Tu suscripción" o, si no lo encuentra,
     al inicio del contenido principal.

   Cómo probar:
   - En Supabase, cambia expires_at de tu KEY a ayer/mañana y recarga premium.html.
=====================================================================*/
(function () {
  const PHONE = '50762796078';       // WhatsApp/Yappy (sin +)
  const THRESHOLD_DAYS = 10;         // Muestra aviso si faltan ≤ 10 días
  const WA_BASE = `https://wa.me/${PHONE}`;

  // Utilidades
  const get = (k) => localStorage.getItem(k) || '';
  const KEY   = get('ingresou_key')   || get('KEY');
  const EMAIL = get('ingresou_email') || get('EMAIL');

  const fmt = (dateStr) => {
    const d = new Date(dateStr);
    if (isNaN(d)) return '';
    return d.toLocaleDateString('es-PA', { day:'2-digit', month:'2-digit', year:'numeric' });
  };
  const daysLeft = (dateStr) => {
    const now = new Date(), d = new Date(dateStr);
    return Math.ceil((d - now) / (1000*60*60*24));
  };

  // Encuentra un buen lugar para insertar el banner (debajo de "Tu suscripción")
  function findMountPoint() {
    // 1) Tarjeta que contenga "Tu suscripción"
    const byText = Array.from(document.querySelectorAll('h1,h2,h3,div,section'))
      .find(el => /tu suscripci[oó]n/i.test(el.textContent || ''));
    if (byText && byText.parentElement) return byText.parentElement;

    // 2) Un contenedor de página común (si usas tailwind: max-w-*)
    const main = document.querySelector('[class*="max-w-"], main, .container');
    if (main) return main;

    // 3) Como último recurso, el body
    return document.body;
  }

  // Intenta leer fecha de la UI si la API no responde
  function tryReadExpiresFromDOM() {
    // Busca "Vence <fecha>" en cualquier nodo
    const node = Array.from(document.querySelectorAll('div,span,p'))
      .find(el => /vence/i.test(el.textContent || ''));
    if (!node) return '';
    const m = (node.textContent || '').match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
    if (!m) return '';
    const [, dd, mm, yyyy] = m;
    return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T00:00:00`;
  }

  // Crea e inserta el banner
  function renderBanner({ university, plan, expires_at }) {
    if (!expires_at) return;
    const d = daysLeft(expires_at);
    if (isNaN(d) || d > THRESHOLD_DAYS) return;   // aún falta mucho → no mostrar

    const expired = d <= 0;
    const colorBox = expired ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200';
    const chipBG   = expired ? 'bg-red-100' : 'bg-yellow-100';
    const chipText = expired ? 'text-red-700' : 'text-yellow-700';
    const title    = expired
      ? `Tu plan expiró el ${fmt(expires_at)} (hace ${Math.abs(d)} día${Math.abs(d)===1?'':'s'}).`
      : `Tu plan vence el ${fmt(expires_at)} (en ${d} día${d===1?'':'s'}).`;

    const msg = encodeURIComponent(
      `Hola! Quiero ${expired ? 'renovar' : 'renovar antes del vencimiento'} mi plan de IngresoU.` +
      `\nUniversidad: ${university || 'UTP/UP'}` +
      `\nPlan: ${plan || 'Pro 60d — $29'}` +
      `\nKEY: ${KEY || '-'}` +
      `\nEmail: ${EMAIL || '-'}` +
      `\nVence: ${fmt(expires_at)}`
    );
    const waLink = `${WA_BASE}?text=${msg}`;

    const mount = findMountPoint();
    const banner = document.createElement('div');
    banner.className = `mt-4 rounded-xl border p-4 ${colorBox}`;
    banner.innerHTML = `
      <div class="flex items-start gap-4">
        <div class="shrink-0 rounded-full ${chipBG} px-2 py-1 text-xs ${chipText}">Aviso</div>
        <div class="flex-1">
          <div class="font-semibold ${expired ? 'text-red-700' : 'text-yellow-700'}">${title}</div>
          <p class="mt-1 text-sm text-gray-700">Renueva ahora para no perder acceso a simuladores, exámenes y rankings.</p>
          <div class="mt-3 flex flex-wrap gap-2">
            <a href="${waLink}" target="_blank"
               class="inline-flex items-center rounded-lg bg-green-600 px-3 py-1.5 text-white text-sm hover:opacity-90">
               Renovar por WhatsApp
            </a>
            <button id="copy-renew-info"
               class="inline-flex items-center rounded-lg border px-3 py-1.5 text-sm hover:bg-gray-50">
               Copiar datos
            </button>
          </div>
          <p class="mt-2 text-xs text-gray-500">Tel: +507 ${PHONE}</p>
        </div>
      </div>
    `;
    // Inserta debajo del bloque detectado
    mount.parentElement ? mount.parentElement.insertBefore(banner, mount.nextSibling) : mount.prepend(banner);

    // Copiar al portapapeles
    banner.querySelector('#copy-renew-info')?.addEventListener('click', () => {
      const text =
`Renovación IngresoU
Universidad: ${university || ''}
Plan: ${plan || ''}
KEY: ${KEY || ''}
Email: ${EMAIL || ''}
Vence: ${fmt(expires_at)} (${expired ? 'expirado' : d + ' días restantes'})`;
      navigator.clipboard.writeText(text);
    });
  }

  // Carga datos (API si puede, si no, DOM/localStorage)
  async function init() {
    let sub = null;
    try {
      if (KEY && EMAIL) {
        const r = await fetch('/api/get-subscription', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ code: KEY, email: EMAIL })
        });
        const data = await r.json();
        sub = data?.subscription || data || null;
      }
    } catch (e) { /* ignorar, seguimos con fallback */ }

    const university = sub?.university || get('ingresou_university') || '';
    const plan       = sub?.plan       || get('ingresou_plan')       || '';
    let   expires_at = sub?.expires_at || sub?.expiresAt || '';

    if (!expires_at) {
      expires_at = tryReadExpiresFromDOM(); // último recurso: leer "Vence dd/mm/yyyy"
    }

    if (expires_at) {
      renderBanner({ university, plan, expires_at });
    }
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
<script>
/* ===== IngresoU – Auto-redimir KEY en el login =====
   Qué hace:
   - Toma KEY + email del formulario.
   - Llama a /api/get-subscription.
   - Si responde NOT_REDEEMED -> llama /api/redeem-key y reintenta.
   - Si OK -> guarda en localStorage y redirige a /premium.html.
   - Maneja EXPIRED/NOT_FOUND/EMAIL_MISMATCH con mensajes claros.
*/
(function () {
  // Ajusta si quieres forzar IDs; el script también intenta detectar automáticamente
  const SELECTORS = {
    form:   '#key-login-form, form[data-key-login], .key-login-form, form',
    key:    '#key-input, input[name=key], input[placeholder*="UTP"], input[placeholder*="UP"], input[placeholder*="KEY"]',
    email:  '#email-input, input[type=email], input[name=email], input[placeholder*="@"]',
    submit: '#login-btn, button[type=submit], button'
  };

  function $(sel, root=document){ for (const s of sel.split(',')) { const el = root.querySelector(s.trim()); if (el) return el; } return null; }
  function setStatus(msg, type='info') {
    let el = document.getElementById('key-status');
    if (!el) {
      el = document.createElement('div');
      el.id = 'key-status';
      el.style.marginTop = '8px';
      el.style.fontSize = '12px';
      const cont = $('#key-login-form') || $('form') || document.body;
      cont.appendChild(el);
    }
    const colors = {info:'#374151',ok:'#059669',warn:'#b45309',err:'#b91c1c'};
    el.style.color = colors[type] || colors.info;
    el.textContent = msg;
  }

  async function apiGetSub(code, email) {
    const r = await fetch('/api/get-subscription', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code, email })
    });
    return r.json();
  }
  async function apiRedeem(code, email) {
    const r = await fetch('/api/redeem-key', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code, email })
    });
    return r.json();
  }

  async function handleLogin(e) {
    e?.preventDefault?.();
    const keyEl   = $(SELECTORS.key);
    const mailEl  = $(SELECTORS.email);
    if (!keyEl || !mailEl) { setStatus('No encuentro los campos de KEY y correo.', 'err'); return; }
    const code  = (keyEl.value || '').trim().toUpperCase();
    const email = (mailEl.value || '').trim().toLowerCase();
    if (!code || !email) { setStatus('Ingresa tu KEY y tu correo.', 'warn'); return; }

    setStatus('Verificando acceso…');

    try {
      let res = await apiGetSub(code, email);

      // Si backend anida la suscripción, normalizamos
      const payload = res?.subscription || res;

      if (payload?.ok === false && payload?.error === 'NOT_REDEEMED') {
        setStatus('Activando tu KEY…');
        const r2 = await apiRedeem(code, email);
        if (r2?.ok) {
          setStatus('KEY activada. Entrando…', 'ok');
          res = await apiGetSub(code, email);
        } else {
          setStatus('No se pudo activar: ' + (r2?.error || 'ERROR'), 'err');
          return;
        }
      }

      // Revisamos estados comunes
      if (res?.ok === false) {
        const err = res?.error || 'ERROR';
        if (err === 'NOT_FOUND')       setStatus('La KEY no existe. Verifica que la emitiste en DB.', 'err');
        else if (err === 'EXPIRED')    setStatus('Tu KEY está vencida. Solicita renovación.', 'err');
        else if (err === 'EMAIL_MISMATCH') setStatus('El correo no coincide con el de emisión. Usa el mismo correo o emite una nueva KEY.', 'err');
        else setStatus('Error: ' + err, 'err');
        return;
      }

      // Si llegó hasta aquí, todo bien: guardamos y entramos
      localStorage.setItem('ingresou_key', code);
      localStorage.setItem('ingresou_email', email);
      // Si vienen datos útiles, guárdalos para el banner y la UI
      if (res?.university) localStorage.setItem('ingresou_university', res.university);
      if (res?.plan)       localStorage.setItem('ingresou_plan', res.plan);
      if (res?.expires_at) localStorage.setItem('ingresou_expires_at', res.expires_at);

      setStatus('Acceso verificado. Redirigiendo…', 'ok');
      location.href = '/premium.html';
    } catch (e) {
      console.error(e);
      setStatus('Error de red o servidor. Intenta de nuevo.', 'err');
    }
  }

  // Enlaza el handler al submit del formulario (o al botón)
  function bind() {
    const form  = $(SELECTORS.form);
    const btn   = $(SELECTORS.submit);
    if (form)  form.addEventListener('submit', handleLogin);
    if (btn)   btn.addEventListener('click', handleLogin);
  }

  document.addEventListener('DOMContentLoaded', bind);
})();
</script>
<script>
/* ===== IngresoU – Auto-redimir KEY en el login =====
   - Verifica la KEY y si está NOT_REDEEMED, la activa y vuelve a verificar.
   - Si OK, guarda datos en localStorage y entra a /premium.html.
*/
(function () {
  const SELECTORS = {
    form:   '#key-login-form, form[data-key-login], .key-login-form, form',
    key:    '#key-input, input[name=key], input[placeholder*="UTP"], input[placeholder*="UP"], input[placeholder*="KEY"], input[type="text"]',
    email:  '#email-input, input[type=email], input[name=email], input[placeholder*="@"]',
    submit: '#login-btn, button[type=submit], button'
  };

  function $(sel, root=document){ for (const s of sel.split(',')) { const el = root.querySelector(s.trim()); if (el) return el; } return null; }
  function statusHost(){
    // Intenta escribir el mensaje dentro de la tarjeta "Inicia sesión con tu KEY"
    const card = Array.from(document.querySelectorAll('div,section'))
      .find(el => /inicia sesi[oó]n con tu key/i.test(el.textContent||''));
    return card || document.body;
  }
  function setStatus(msg, type='info'){
    let el = document.getElementById('key-status');
    if (!el) {
      el = document.createElement('div');
      el.id = 'key-status';
      el.style.marginTop = '8px';
      el.style.fontSize = '12px';
      statusHost().appendChild(el);
    }
    const colors = {info:'#374151',ok:'#059669',warn:'#b45309',err:'#b91c1c'};
    el.style.color = colors[type] || colors.info;
    el.textContent = msg;
  }

  async function apiGetSub(code, email) {
    const r = await fetch('/api/get-subscription', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code, email })
    });
    return r.json();
  }
  async function apiRedeem(code, email) {
    const r = await fetch('/api/redeem-key', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code, email })
    });
    return r.json();
  }

  async function handleLogin(e) {
    e?.preventDefault?.();
    const keyEl   = $(SELECTORS.key);
    const mailEl  = $(SELECTORS.email);
    if (!keyEl || !mailEl) { setStatus('No encuentro los campos de KEY y correo.', 'err'); return; }

    const code  = (keyEl.value || '').trim().toUpperCase();
    const email = (mailEl.value || '').trim().toLowerCase();
    if (!code || !email) { setStatus('Ingresa tu KEY y tu correo.', 'warn'); return; }

    setStatus('Verificando acceso…');

    try {
      let res = await apiGetSub(code, email);
      let payload = res?.subscription || res;

      if (payload?.ok === false && payload?.error === 'NOT_REDEEMED') {
        setStatus('Activando tu KEY…');
        const r2 = await apiRedeem(code, email);
        if (!(r2?.ok || r2?.error === 'ALREADY_REDEEMED')) {
          setStatus('No se pudo activar: ' + (r2?.error || 'ERROR'), 'err');
          return;
        }
        res = await apiGetSub(code, email);
        payload = res?.subscription || res;
      }

      if (payload?.ok === false) {
        const err = payload?.error || 'ERROR';
        if (err === 'NOT_FOUND')         setStatus('La KEY no existe en DB. En admin.html pulsa "Emitir en DB".', 'err');
        else if (err === 'EXPIRED')      setStatus('La KEY está vencida. Solicita renovación.', 'err');
        else if (err === 'EMAIL_MISMATCH') setStatus('El correo no coincide con el de emisión. Usa el mismo correo o emite otra KEY.', 'err');
        else setStatus('Error: ' + err, 'err');
        return;
      }

      // Guardar y entrar
      localStorage.setItem('ingresou_key', code);
      localStorage.setItem('ingresou_email', email);
      if (payload?.university) localStorage.setItem('ingresou_university', payload.university);
      if (payload?.plan)       localStorage.setItem('ingresou_plan', payload.plan);
      if (payload?.expires_at) localStorage.setItem('ingresou_expires_at', payload.expires_at);

      setStatus('Acceso verificado. Entrando…', 'ok');
      location.href = '/premium.html';
    } catch (e) {
      console.error(e);
      setStatus('Error de red o servidor. Intenta de nuevo.', 'err');
    }
  }

  function bind() {
    const form  = $(SELECTORS.form);
    const btn   = $(SELECTORS.submit);
    if (form)  form.addEventListener('submit', handleLogin);
    if (btn)   btn.addEventListener('click', handleLogin);
  }

  document.addEventListener('DOMContentLoaded', bind);
})();
</script>
<script>
/* ===== IngresoU – Forzar auto-redimir en botón "Entrar" (capturing) ===== */
(function () {
  // Busca inputs de KEY y email en la tarjeta "Inicia sesión con tu KEY"
  function findInputs(root=document){
    const card = Array.from(root.querySelectorAll('div,section'))
      .find(el => /inicia sesi[oó]n con tu key/i.test(el.textContent||''));
    const scope = card || root;
    const keyEl = scope.querySelector(
      'input[name=key], input[placeholder*="UTP"], input[placeholder*="UP"], input[placeholder*="KEY"], input[type="text"]'
    );
    const mailEl = scope.querySelector(
      'input[type=email], input[name=email], input[placeholder*="@"]'
    );
    return { keyEl, mailEl, card: scope };
  }
  function setStatus(msg, type='info'){
    let el = document.getElementById('key-status');
    if(!el){
      el = document.createElement('div');
      el.id = 'key-status';
      el.style.marginTop = '8px';
      el.style.fontSize = '12px';
      (findInputs().card || document.body).appendChild(el);
    }
    const colors = {info:'#374151',ok:'#059669',warn:'#b45309',err:'#b91c1c'};
    el.style.color = colors[type] || colors.info;
    el.textContent = msg;
  }
  async function getSub(code,email){
    const r = await fetch('/api/get-subscription',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code, email })
    });
    return r.json();
  }
  async function redeem(code,email){
    const r = await fetch('/api/redeem-key',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ code, email })
    });
    return r.json();
  }
  async function flowLogin(code,email){
    setStatus('Verificando acceso…');
    let res = await getSub(code,email);
    if(res?.subscription) res = res.subscription;

    if(res?.ok === false && res?.error === 'NOT_REDEEMED'){
      setStatus('Activando tu KEY…');
      const r2 = await redeem(code,email);
      if(!(r2?.ok || r2?.error === 'ALREADY_REDEEMED')){
        setStatus('No se pudo activar: ' + (r2?.error || 'ERROR'), 'err'); 
        return false;
      }
      res = await getSub(code,email);
      if(res?.subscription) res = res.subscription;
    }

    if(res?.ok === false){
      const err = res?.error || 'ERROR';
      if (err === 'NOT_FOUND') setStatus('La KEY no existe en DB. En admin.html pulsa "Emitir en DB".','err');
      else if (err === 'EXPIRED') setStatus('La KEY está vencida. Solicita renovación.','err');
      else if (err === 'EMAIL_MISMATCH') setStatus('El correo no coincide con el de emisión.','err');
      else setStatus('Error: ' + err,'err');
      return false;
    }

    // Guardar y entrar
    localStorage.setItem('ingresou_key', code);
    localStorage.setItem('ingresou_email', email);
    if(res?.university) localStorage.setItem('ingresou_university', res.university);
    if(res?.plan)       localStorage.setItem('ingresou_plan',       res.plan);
    if(res?.expires_at) localStorage.setItem('ingresou_expires_at', res.expires_at);

    setStatus('Acceso verificado. Entrando…','ok');
    location.href = '/premium.html';
    return true;
  }

  // Intercepta **cualquier** clic en botón "Entrar" (capturing) y corre nuestro flujo
  document.addEventListener('click', async (ev) => {
    const target = ev.target.closest('button, input[type=submit]');
    if(!target) return;
    const label = (target.textContent || target.value || '').trim().toLowerCase();
    if(label !== 'entrar') return;

    const { keyEl, mailEl } = findInputs();
    if(!keyEl || !mailEl) return; // si no encontramos el form, no tocamos nada

    ev.preventDefault();
    ev.stopPropagation();

    const code  = (keyEl.value || '').trim().toUpperCase();
    const email = (mailEl.value || '').trim().toLowerCase();
    if(!code || !email){ setStatus('Ingresa tu KEY y tu correo.','warn'); return; }

    try { await flowLogin(code,email); }
    catch(e){ console.error(e); setStatus('Error de red/servidor.','err'); }
  }, true); // <-- capturing: intercepta antes del handler original
})();
</script>

</body>
</html>
