
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IngresoU — Práctica Álgebra</title>
  <!-- PAGES PATCH 1755048408 -->
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;max-width:960px;margin:40px auto;padding:0 16px;color:#111}
    .card{border:1px solid #E5E7EB;border-radius:12px;padding:16px;background:#fff;margin-top:12px}
    .mut{color:#6B7280}
    .btn{background:#4F46E5;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn-outline{border:1px solid #D1D5DB;background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .q{margin-top:12px;padding:12px;border-radius:8px;border:1px solid #E5E7EB;background:#F9FAFB}
    .ops label{display:block;margin:6px 0}
    .ok{color:#059669} .err{color:#b91c1c}
    progress{width:100%}
  </style>
</head>
<body>
  
<header style="display:flex;justify-content:space-between;align-items:center;padding:12px 0">
  <div style="font-weight:700;font-size:20px;">IngresoU</div>
  <nav style="display:flex;gap:12px;">
    <a href="/premium.html">Mi cuenta</a>
    <a href="/leaderboard.html">Ranking</a>
  </nav>
</header>

  
<script>
(function(){
  const code = localStorage.getItem('ingresou_key');
  const email = localStorage.getItem('ingresou_email');
  if (!code || !email){
    location.href = '/';
  }
})();
</script>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <h1 style="font-size:22px;margin:0">Práctica — Álgebra</h1>
      <div class="mut" id="session"></div>
    </div>
    <div class="mut">10 preguntas • tiempo cronometrado</div>
    <progress id="prog" value="0" max="10"></progress>

    <div id="qwrap"></div>

    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="prev" class="btn-outline">Anterior</button>
      <button id="next" class="btn">Siguiente</button>
      <button id="finish" class="btn" style="display:none;background:#059669">Finalizar</button>
    </div>

    <div id="result" style="display:none;margin-top:12px;"></div>
  </div>

<script>
const TOPIC = 'algebra';
const SAMPLES = [{"question": "¿Cuál es el valor de x si 2x + 6 = 18?", "choices": ["4", "5", "6", "8"], "answer_index": 1}, {"question": "Factoriza: x^2 - 9", "choices": ["(x-9)(x+1)", "(x-3)(x+3)", "(x-9)^2", "x(x-9)"], "answer_index": 1}, {"question": "Resuelve: 3(x - 2) = 12", "choices": ["x=6", "x=4", "x=2", "x=8"], "answer_index": 1}, {"question": "Si a=2 y b=3, entonces 2ab es:", "choices": ["6", "10", "12", "8"], "answer_index": 2}, {"question": "Simplifica: 6x/3", "choices": ["2", "2x", "3x", "x/2"], "answer_index": 1}, {"question": "¿Cuál es la pendiente de y = 5x - 7?", "choices": ["-7", "5", "7", "-5"], "answer_index": 1}, {"question": "(x^2)(x^3) =", "choices": ["x^5", "x^6", "x^3", "x^2"], "answer_index": 0}, {"question": "Si 4x = 28, x =", "choices": ["5", "6", "7", "8"], "answer_index": 2}, {"question": "Resuelve: x^2 = 81", "choices": ["x=9", "x=-9", "x=9 o x=-9", "x=0"], "answer_index": 2}, {"question": "Factoriza: x^2 + 5x + 6", "choices": ["(x+3)(x+2)", "(x+6)(x-1)", "(x+5)(x+1)", "(x+2)(x-3)"], "answer_index": 0}];

function ls(k){try{return localStorage.getItem(k)||''}catch{return ''}}
function obfuscEmail(e){ if(!e) return ''; const p=e.split('@')[0]; return p.length>2 ? p.slice(0,2)+'***' : p; }

async function getQuestions(topic, count){
  try{ 
    const r = await fetch('/api/generate-questions',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topic, count }) });
    if(r.ok){ const j=await r.json(); if(Array.isArray(j) && j.length) return j.slice(0,count); }
  }catch(e){ console.warn('API fallback', e); }
  return SAMPLES.slice(0, count);
}

function renderQuestion(q, idx, sel){
  const wrap = document.getElementById('qwrap');
  const ops = q.choices.map((c,i)=>'<label><input type="radio" name="op" value="'+i+'" '+(sel===i?'checked':'')+'> '+c+'</label>').join('');
  wrap.innerHTML = '<div class="q"><div style="font-weight:600;margin-bottom:8px;">'+(idx+1)+') '+q.question+'</div><div class="ops">'+ops+'</div></div>';
}

(async function(){
  document.getElementById('session').textContent = obfuscEmail(ls('ingresou_email'))+' • KEY: '+(ls('ingresou_key')||'').slice(0,4)+'***';
  const qs = await getQuestions(TOPIC, 10);
  let i=0; let answers = new Array(qs.length).fill(null); let start=Date.now();
  const prog=document.getElementById('prog'), prev=document.getElementById('prev'),
        next=document.getElementById('next'), finish=document.getElementById('finish'),
        result=document.getElementById('result');

  function updateButtons(){
    prev.disabled = i===0;
    next.style.display = i<qs.length-1 ? 'inline-block' : 'none';
    finish.style.display = i===qs.length-1 ? 'inline-block' : 'none';
    prog.value = answers.filter(x=>x!==null).length;
  }

  function currentSelection(){
    const el = document.querySelector('input[name="op"]:checked');
    return el ? parseInt(el.value,10) : null;
  }

  function saveSelection(){
    const v = currentSelection();
    if (v!==null) answers[i]=v;
  }

  renderQuestion(qs[i], i, answers[i]); updateButtons();

  document.getElementById('qwrap').addEventListener('change', saveSelection);
  prev.onclick = ()=>{ if(i>0){ saveSelection(); i--; renderQuestion(qs[i], i, answers[i]); updateButtons(); } };
  next.onclick = ()=>{ if(i<qs.length-1){ saveSelection(); i++; renderQuestion(qs[i], i, answers[i]); updateButtons(); } };
  finish.onclick = async ()=>{ saveSelection();
    const dur = Math.round((Date.now()-start)/1000);
    const score = answers.reduce((acc,v,idx)=> acc + (v===qs[idx].answer_index?1:0), 0);
    result.style.display='block';
    result.innerHTML = '<div class="q"><div><strong>Resultado:</strong> '+score+' / '+qs.length+'</div><div class="mut">Tiempo: '+dur+' s • Tema: '+TOPIC+'</div></div>';

    try{
      const payload = { email: ls('ingresou_email'), code: ls('ingresou_key'), topic: TOPIC, score, duration: dur, ts: new Date().toISOString() };
      const r = await fetch('/api/submit-score',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(r.ok){ const j=await r.json(); console.log('submit-score', j); }
    }catch(e){ console.warn('submit-score fallback', e); }
  };
})();
</script>
</body>
</html>
